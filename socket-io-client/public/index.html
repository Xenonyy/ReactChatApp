<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#000000" />
		<meta
			name="description"
			content="Web site created using create-react-app"
		/>
		<link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
		<link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
		<title>React App</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.1/socket.io.js" integrity="sha512-oFOCo2/3DtjrJG4N27BjSLQWoiBv171sK6a+JiWjp/7agxC2nCUP358AqzxkBUb5jX8g6CYLPdSKQTbC0weCwA==" crossorigin="anonymous"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script
			src="https://code.jquery.com/jquery-3.4.1.min.js"
			integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			crossorigin="anonymous"></script>
		<script defer>
			const socket = io();
		
			window.onload = () => {
				// Usernames
				async function setUsername() {
					const button = document.querySelector('#username-button');
					const welcome = document.querySelector('#welcome-page');
					button.addEventListener("click", () => {
						const userName = document.querySelector('#username-input').value;
						let userArr = [];
						userArr.push(userName);
						socket.emit('new user', userName);
						socket.on('new user', (data) => {
							$(".update-users-p").remove(); // Remove all p elements, before creating the updated ones.
							let users = data.data;
							for (const user of users) {
								const onlineUsers = document.createElement('p')
								$("p").addClass("update-users-p");
								onlineUsers.textContent = `â€¢ ${user}`;
								$("#users").append(onlineUsers);
								// $(".username").text(data.data);
							}
							console.log(users);
							// Style Usernames
							// if ($("li").textContent.match(users)) {
							// 	let nameFromInput = document.querySelector('#username-input').value;
							// 	let replacer = $("li").textContent.replace(new RegExp(`${users}`, 'g'), `<li style="color:pink; font-size:1.4rem; font-style:bold; display:block;"> ${users} </li>`);
							// 	$("li").innerHTML = replacer;
							// }
						});
					});
				}
				async function socketstuff() {
					// const userName = document.querySelector('#username-input').nodeValue;
					await setUsername();

					
					socket.on('newClientConnect', (data) => {
						$("#users-connected").text(data.description);
					});

					// Send messages
					const form = document.querySelector('#form');
					const input = document.querySelector('#input');
					const chat = document.querySelector("#chat-container");
				
					form.addEventListener('submit', (e) => {
						e.preventDefault();
						if (input.value.length > 0) {
							socket.emit('chat message', input.value);
							input.value = '';
						}
					});

					// Messages
					socket.on('chat message', (msg) => {
						const item = document.createElement('li');
						item.textContent = msg;
						messages.appendChild(item);
						chat.scrollTo(0, chat.scrollHeight);
					});

					// Typing...
					var typing = false;
					var timeout = undefined;

					const typingTimeout = () => { 
						typing = false;
						socket.emit('typing', "");
					}
					input.addEventListener('keypress', (e) => {
						let nameFromInput = document.querySelector('#username-input').value;
						if(e.which != 13) {
							typing = true;
							socket.emit('typing', `${nameFromInput} is typing a message...`);
							clearTimeout(timeout);
							timeout = setTimeout(typingTimeout, 2000);
						} else {
							timeout = setTimeout(typingTimeout, 2000);
						}
						if (e.keyCode === 13) {
							typing = false;
							socket.emit('typing', "");
						}
						socket.on('typing', (data) => {
							document.getElementById("typing").innerText = data;
						});
					});
				}
				socketstuff();
			}
		</script>
	</head>
	<body>
		<noscript>You need to enable JavaScript to run this app.</noscript>
		<div id="root"></div>
	</body>
</html>
