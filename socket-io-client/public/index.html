<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#000000" />
		<meta
			name="description"
			content="Web site created using create-react-app"
		/>
		<link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
		<link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
		<title>React App</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.1/socket.io.js" integrity="sha512-oFOCo2/3DtjrJG4N27BjSLQWoiBv171sK6a+JiWjp/7agxC2nCUP358AqzxkBUb5jX8g6CYLPdSKQTbC0weCwA==" crossorigin="anonymous"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script 
			defer
			src="https://code.jquery.com/jquery-3.4.1.min.js"
			integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			crossorigin="anonymous"></script>
		<script defer>
			const socket = io();
		
			window.onload = () => {
				// Usernames
				let users = [];
				async function setUsername() {
					const button = document.querySelector('#username-button');
					const welcome = document.querySelector('#welcome-page');
					const usernameInput = document.getElementById("username-input");
					
					usernameInput.addEventListener('keypress', (e) => {
						if(e.key == "Enter") {
							const userName = document.querySelector('#username-input').value;
							let userArr = [];
							userArr.push(userName);
							socket.emit('new user', userName);
							socket.on('new user', (data) => {
								$("span").remove(); // Remove all span elements, before creating the updated ones.
								users.pop(); // Remove users before puhsing the data again.
								users.push(data.data);
								let currentUsers = data.data;
								for (const user of currentUsers) {
									const onlineUsers = document.createElement('span');
									onlineUsers.textContent = `• ${user}`;
									$("#users").append(onlineUsers);
								}
								console.log(users);
							});
							console.log("enter223")
						}
					});
					button.addEventListener("click", () => {
						const userName = document.querySelector('#username-input').value;
						let userArr = [];
						userArr.push(userName);
						socket.emit('new user', userName);
						socket.on('new user', (data) => {
							$("span").remove(); // Remove all span elements, before creating the updated ones.
							users.pop(); // Remove users before puhsing the data again.
							users.push(data.data);
							let currentUsers = data.data;
								for (const user of currentUsers) {
								const onlineUsers = document.createElement('span');
								onlineUsers.textContent = `• ${user}`;
								$("#users").append(onlineUsers);
							}
							console.log(users);
						});
					});
				}
				async function socketstuff() {
					// const userName = document.querySelector('#username-input').nodeValue;
					await setUsername();

					
					socket.on('newClientConnect', (data) => {
						$("#users-connected").text(data.description);
					});

					// Send messages
					const form = document.querySelector('#form');
					const input = document.querySelector('#input');
					const chat = document.querySelector("#chat-container");
				
					form.addEventListener('submit', (e) => {
						e.preventDefault();
						if (input.value.length > 0) {
							socket.emit('chat message', input.value);
							input.value = '';
						}
					});

					// Messages
					socket.on('chat message', (msg) => {
						const getDate = () => {
							let date = new Date();
							let hours = date.getHours();
							let minutes = date.getMinutes();
							let ampm = hours >= 12 ? 'pm' : 'am';
							hours = hours % 12;
							hours = hours ? hours : 12; // the hour '0' should be '12'
							minutes = minutes < 10 ? '0'+ minutes : minutes;

							let strTime = hours + ':' + minutes + ' ' + ampm;
							return strTime;
						}
						const item = document.createElement('li');
						item.textContent = `${getDate()}  ${msg}`;
						messages.appendChild(item);
						chat.scrollTo(0, chat.scrollHeight);

						// Insert date before messages
						if (item.textContent.match(getDate())) {
							let replacer = item.innerHTML.replace(new RegExp(`${getDate()}`, 'g'), `<li style="color:pink; font-size:0.7rem; display:contents">${getDate()}</li> `);
							item.innerHTML = replacer;
						}
						// Style Usernames
						for (const user of users) {
							for (const individualUser of user) {
								console.log(individualUser);
								if (item.textContent.match(`@${individualUser}`)) {
									let replacer = item.innerHTML.replace(new RegExp(`@${individualUser}`, 'g'), `<li style="color:pink; font-size:1.3rem; display:contents">@${individualUser}</li> `);
									item.innerHTML = replacer;
									// let replacer0 = item.innerHTML.replace(new RegExp(`${individualUser}`, 'gi'), `<li style="color:pink; font-size:1.3rem; font-weight:500;">${individualUser}</li> `);
									// item.innerHTML = replacer0;
								}
								if (item.textContent.match(individualUser)) {
									let replacer = item.innerHTML.replace(new RegExp(`${individualUser}`, 'g'), `<li style="color:pink; font-size:1.3rem; font-weight:500; display:contents">${individualUser}</li> `);
									item.innerHTML = replacer;
								}
							}
						}
					});

					// Typing...
					var typing = false;
					var timeout = undefined;

					const typingTimeout = () => { 
						typing = false;
						socket.emit('typing', "");
					}
					input.addEventListener('keypress', (e) => {
						let nameFromInput = document.querySelector('#username-input').value;
						if(e.which != 13) {
							typing = true;
							socket.emit('typing', `${nameFromInput} is typing a message...`);
							clearTimeout(timeout);
							timeout = setTimeout(typingTimeout, 1000);
						} else {
							timeout = setTimeout(typingTimeout, 1000);
						}
						if (e.keyCode === 13) {
							typing = false;
							socket.emit('typing', "");
						}
						socket.on('typing', (data) => {
							document.getElementById("typing").innerText = data;
						});
					});
				}
				socketstuff();
			}
		</script>
	</head>
	<body>
		<noscript>You need to enable JavaScript to run this app.</noscript>
		<div id="root"></div>
	</body>
</html>
